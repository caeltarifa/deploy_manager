#!/bin/bash

WORKING_DIR="{{ working_dir }}"
CA_PASSPHRASE="{{ ca_passphrase }}"

mkdir -p "${WORKING_DIR}/pki"

if [ ! -f "${WORKING_DIR}/pki/ca.crt" ]; then
    echo "CA certificate not found. Initializing PKI using expect..."
    expect -c "
        set timeout -1
        spawn docker run -v \"${WORKING_DIR}:/etc/openvpn\" --rm -it kylemanna/openvpn ovpn_initpki
        expect \"Enter PEM pass phrase:\"
        send \"$CA_PASSPHRASE\\r\"
        expect \"Verifying - Enter PEM pass phrase:\"
        send \"$CA_PASSPHRASE\\r\"
        expect eof
        catch wait result
        exit [lindex \$result 3]
    "
    if [ $? -eq 0 ]; then
        echo "OpenVPN PKI initialized successfully."
    else
        echo "Error: Failed to initialize OpenVPN PKI."
        exit 1
    fi
else
    echo "CA certificate already exists. Skipping PKI initialization."
fi